theme(text = element_text(size = text_size))
# fitted timediff by stage
colors = c("true" = "#39558CFF", "fitted" = "#56C667FF", "predicted" = "#E55C30FF")
tibble(x = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(stage),
fitted = tweedie1$fitted.values,
true = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(timediff)) %>%
ggplot(aes(x, fitted)) +
geom_point(aes(color = "fitted"), alpha = 0.9) +
geom_point(aes(x + 0.25, true, color = "true"), alpha = 0.9) +
geom_point(data = tibble(xx = 20.25, true = stages_2020 %>% dplyr::filter(stage == 20) %>% pull(timediff)),
aes(xx, true, color = "true")) +
geom_point(data = tibble(xx = 20, predicted = preds),
aes(xx, predicted, color = "predicted")) +
labs(x = "stage",
y = "time difference to leader (seconds)",
color = "") +
scale_color_manual(values = colors) +
theme(text = element_text(size = text_size))
tibble(x = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(stage),
fitted = tweedie1$fitted.values,
true = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(timediff)) %>%
ggplot(aes(x, fitted)) +
geom_point(aes(color = "fitted"), alpha = 0.9) +
geom_point(aes(x + 0.25, true, color = "true"), alpha = 0.9) +
geom_point(data = tibble(xx = 20.25, true = stages_2020 %>% dplyr::filter(stage == 20) %>% pull(timediff)),
aes(xx, true, color = "true")) +
geom_point(data = tibble(xx = 20, predicted = preds),
aes(xx, predicted, color = "predicted")) +
labs(x = "stage",
y = "time difference to leader (seconds)",
color = "") +
scale_color_manual(values = colors, breaks = c("true", "fitted", "predicted")) +
theme(text = element_text(size = text_size))
tibble(x = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(stage),
fitted = tweedie1$fitted.values,
true = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(timediff)) %>%
ggplot(aes(x, fitted)) +
geom_point(aes(color = "fitted"), alpha = 0.9) +
geom_point(aes(x + 0.25, true, color = "true"), alpha = 0.9) +
geom_point(data = tibble(xx = 20.25, true = stages_2020 %>% dplyr::filter(stage == 20) %>% pull(timediff)),
aes(xx, true, color = "true")) +
geom_point(data = tibble(xx = 20, predicted = preds),
aes(xx, predicted, color = "predicted")) +
labs(x = "stage",
y = "time difference to leader (seconds)",
color = "") +
scale_color_manual(values = colors, breaks = c("true", "fitted", "predicted")) +
theme(text = element_text(size = text_size),
legend.position = "top")
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, timediff) %>%
dplyr::mutate(prediction = preds,
min_prediction = prediction - min(prediction),
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0))
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
stages_2020 %>%
ggplot(aes(x = distance, y = timediff)) +
geom_jitter(width = 2) +
labs(x = "stage distance (km)",
y = "time difference to leader (seconds)") +
theme(text = element_text(text_size))
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
pred_data
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, timediff) %>%
dplyr::mutate(prediction = preds,
min_prediction = prediction - min(prediction),
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0))
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
min_prediction = prediction - min(prediction),
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0))
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n())
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
top_n(10, wt = -gc_rank)
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
top_n(10, wt = -gc_rank) %>%
dplyr::arrange(gc_rank)
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
dplyr::top_n(10, wt = -gc_rank) %>%
dplyr::arrange(gc_rank) %>%
dplyr::select(rider, gc_rank, pred_gc_rank, prob0)
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
dplyr::top_n(10, wt = -gc_rank) %>%
dplyr::arrange(gc_rank) %>%
dplyr::select(rider, gc_rank, pred_gc_rank, prob0) %>%
View()
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
dplyr::top_n(10, wt = -gc_rank) %>%
dplyr::arrange(gc_rank) %>%
dplyr::select(rider, gc_rank, pred_gc_rank, prob0)
# time difference by contender
stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
# time difference by contender
stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
ggsave("../../doc/fig/timediff_contender.png")
# time difference by contender
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other"))
# time difference by contender
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
) +
coord_flip()
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::arrange(gc_rank) %>%
dplyr::distinct() %>%
dplyr::pull(contender)
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::arrange(gc_rank) %>%
dplyr::distinct(contender)
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::group_by(contender) %>%
dplyr::summarise(gc_rank = mean(gc_rank)) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
# time difference by contender
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::group_by(contender) %>%
dplyr::summarise(gc_rank = mean(gc_rank)) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
) +
coord_flip()
# time difference by contender
breaks <- stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::group_by(contender) %>%
dplyr::summarise(gc_rank = mean(gc_rank)) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
breaks
breaks <- c(breaks, "Egan Bernal")
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = breaks) +
coord_flip()
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = breaks)
+
coord_flip()
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = breaks) +
coord_flip()
# time difference by contender
breaks <- stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
dplyr::filter(stage == 21) %>%
dplyr::group_by(contender) %>%
dplyr::summarise(gc_rank = mean(gc_rank)) %>%
dplyr::arrange(gc_rank) %>%
dplyr::pull(contender)
breaks <- c(breaks, "Egan Bernal")
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = breaks) +
coord_flip()
stages_2020 %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other")) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
scale_x_discrete(breaks = breaks, labels = breaks) +
coord_flip()
stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = contender, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
# time difference by team
stages_2020 %>%
ggplot(aes(x = team, y = timediff)) +
geom_boxplot() +
labs(x = "team",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
# tweedie full
tweedie_training <- stages_2020 %>%
#dplyr::filter(stage < 20) %>%
dplyr::mutate(contender = ifelse(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161), rider, "Other"),
tp = ifelse(rider_number %in% c(131, 11), rider, "Other"),
stage_type = stringr::str_replace(stage_type, "Mountain time trial", "Mountain stage"))
tweedie1 <- glm(timediff ~ stage + distance + rider, data = tweedie_training %>% dplyr::filter(stage < 20),
family = tweedie(var.power = 1.5,link.power = 0))
summary(tweedie1)
pred_data <- tweedie_training %>%
dplyr::filter(stage == 20) %>%
dplyr::select(stage, distance, rider)
preds <- exp(predict(tweedie1, newdata = pred_data)) # exp to get in scale of mean and not log scale
phi <- 7.354021
pred_data <- pred_data %>%
dplyr::mutate(prediction = preds,
logpred = log(preds),
min_prediction = prediction - min(prediction),
lambda = 2* sqrt(logpred) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(prob0)
pred_data
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, timediff) %>%
dplyr::mutate(prediction = preds,
min_prediction = prediction - min(prediction),
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0))
# residuals
tibble(x = tweedie1$fitted.values,
tmp_y = tweedie_training %>% filter(stage<20) %>% pull(timediff),
y = (x - tmp_y) / sqrt(phi * x^(1.5))) %>%
ggplot(aes(x, y)) +
geom_jitter(height = 0.4) +
geom_hline(yintercept = 3, linetype = "dotted") +
geom_hline(yintercept = -3, linetype = "dotted") +
geom_hline(yintercept = 0) +
labs(x = "Fitted values",
y = "Normalized residuals") +
scale_y_continuous(breaks = -5:5) +
theme(text = element_text(size = text_size))
# fitted timediff by stage
colors = c("true" = "#39558CFF", "fitted" = "#56C667FF", "predicted" = "#E55C30FF")
tibble(x = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(stage),
fitted = tweedie1$fitted.values,
true = stages_2020 %>% dplyr::filter(stage < 20) %>% pull(timediff)) %>%
ggplot(aes(x, fitted)) +
geom_point(aes(color = "fitted"), alpha = 0.9) +
geom_point(aes(x + 0.25, true, color = "true"), alpha = 0.9) +
geom_point(data = tibble(xx = 20.25, true = stages_2020 %>% dplyr::filter(stage == 20) %>% pull(timediff)),
aes(xx, true, color = "true")) +
geom_point(data = tibble(xx = 20, predicted = preds),
aes(xx, predicted, color = "predicted")) +
labs(x = "stage",
y = "time difference to leader (seconds)",
color = "") +
scale_color_manual(values = colors, breaks = c("true", "fitted", "predicted")) +
theme(text = element_text(size = text_size),
legend.position = "top")
# top 10 predicted vs actual
stages_2020 %>%
dplyr::filter(stage == 20) %>%
dplyr::select(rider, gc_rank, timediff) %>%
dplyr::mutate(prediction = preds,
lambda = 2* sqrt(prediction) / phi,
prob0 = exp(-lambda)) %>%
dplyr::arrange(desc(prob0)) %>%
dplyr::mutate(pred_gc_rank = 1:n()) %>%
dplyr::top_n(10, wt = -gc_rank) %>%
dplyr::arrange(gc_rank) %>%
dplyr::select(rider, gc_rank, pred_gc_rank, prob0)
source('~/Dropbox/Documents/ubc/2020/2_spring/STAT538/tdf-2020/src/plots/eda.R', echo=TRUE)
library(patchwork)
?ggsave
# time difference by contender
timediff_contender <- stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_point() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
ggsave("../../doc/fig/timediff_contender.png", timediff_contender)
# time difference by team
timediff_team <- stages_2020 %>%
ggplot(aes(x = team, y = timediff)) +
geom_boxplot() +
labs(x = "team",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
ggsave("../../doc/fig/timediff_team.png", timediff_team)
# glue time diff by team and rider in one plot
timediff_contender <- timediff_contender +
labs(tag = "(a)")
timediff_team <- timediff_team +
labs(tag = "(b)")
timediff_contender_team <- timediff_contender + timediff_team
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team)
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team, width = 10)
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team, width = 15)
stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_boxplot() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
# time difference by contender
timediff_contender <- stages_2020 %>%
dplyr::filter(rider_number %in% c(131, 11, 101, 61, 94, 141, 1, 3, 14,
29, 71, 91, 121, 161)) %>%
ggplot(aes(x = rider, y = timediff)) +
geom_boxplot() +
labs(x = "rider",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
ggsave("../../doc/fig/timediff_contender.png", timediff_contender)
# time difference by team
timediff_team <- stages_2020 %>%
ggplot(aes(x = team, y = timediff)) +
geom_boxplot() +
labs(x = "team",
y = "time difference to leader (seconds)",
color = "rider") +
theme(text = element_text(text_size)) +
coord_flip()
ggsave("../../doc/fig/timediff_team.png", timediff_team)
# glue time diff by team and rider in one plot
timediff_contender <- timediff_contender +
labs(tag = "(a)")
timediff_team <- timediff_team +
labs(tag = "(b)")
timediff_contender_team <- timediff_contender + timediff_team
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team, width = 15)
timediff_contender_team <- timediff_contender / timediff_team
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team, height = 10)
ggsave("../../doc/fig/timediff_contender_team.png", timediff_contender_team, height = 12)
